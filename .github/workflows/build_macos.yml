name: Build macOS Application

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verify icon file
      run: |
        if [ ! -f "bbdown_icon.icns" ]; then
          echo "âŒ é”™è¯¯ï¼šé¢„ç”Ÿæˆçš„å›¾æ ‡æ–‡ä»¶ bbdown_icon.icns ä¸å­˜åœ¨"
          echo "è¯·ç¡®ä¿å›¾æ ‡æ–‡ä»¶å·²æ­£ç¡®ç”Ÿæˆå¹¶æäº¤åˆ°ä»“åº“"
          exit 1
        fi
        echo "âœ… å›¾æ ‡æ–‡ä»¶éªŒè¯é€šè¿‡"
        
    - name: Build with PyInstaller
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»º macOS åº”ç”¨ç¨‹åº..."
        
        # ä½¿ç”¨ PyInstaller ç›´æ¥æ„å»º .app åŒ…
         pyinstaller --clean --noconfirm \
           --windowed \
           --name "BBDown GUI" \
           --icon bbdown_icon.icns \
           --osx-bundle-identifier com.bbdown.gui \
           --add-data "bbdown_icon.icns:." \
           bbdown_gui.py
        
        echo "âœ… PyInstaller æ„å»ºå®Œæˆ"
        
    - name: Customize app bundle
      run: |
        APP_NAME="BBDown GUI.app"
        DIST_APP="dist/$APP_NAME"
        
        if [ ! -d "$DIST_APP" ]; then
          echo "âŒ é”™è¯¯ï¼šæ„å»ºçš„åº”ç”¨ç¨‹åºåŒ…ä¸å­˜åœ¨: $DIST_APP"
          exit 1
        fi
        
        echo "ğŸ”§ è‡ªå®šä¹‰åº”ç”¨ç¨‹åºåŒ…..."
        
        # æ›´æ–° Info.plist æ·»åŠ æ›´å¤šå…ƒæ•°æ®
         /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string $(date +%Y%m%d%H%M)" "$DIST_APP/Contents/Info.plist" 2>/dev/null || /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $(date +%Y%m%d%H%M)" "$DIST_APP/Contents/Info.plist"
         /usr/libexec/PlistBuddy -c "Add :CFBundleShortVersionString string 1.0" "$DIST_APP/Contents/Info.plist" 2>/dev/null || /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString 1.0" "$DIST_APP/Contents/Info.plist"
         /usr/libexec/PlistBuddy -c "Add :LSMinimumSystemVersion string 10.15" "$DIST_APP/Contents/Info.plist" 2>/dev/null || /usr/libexec/PlistBuddy -c "Set :LSMinimumSystemVersion 10.15" "$DIST_APP/Contents/Info.plist"
         /usr/libexec/PlistBuddy -c "Add :NSHighResolutionCapable bool true" "$DIST_APP/Contents/Info.plist" 2>/dev/null || /usr/libexec/PlistBuddy -c "Set :NSHighResolutionCapable true" "$DIST_APP/Contents/Info.plist"
         /usr/libexec/PlistBuddy -c "Add :NSSupportsAutomaticGraphicsSwitching bool true" "$DIST_APP/Contents/Info.plist" 2>/dev/null || /usr/libexec/PlistBuddy -c "Set :NSSupportsAutomaticGraphicsSwitching true" "$DIST_APP/Contents/Info.plist"
        
        # ç¡®ä¿å›¾æ ‡æ–‡ä»¶åœ¨æ­£ç¡®ä½ç½®
        cp bbdown_icon.icns "$DIST_APP/Contents/Resources/"
        
        # è®¾ç½®æ­£ç¡®çš„æƒé™
        chmod -R 755 "$DIST_APP"
        chmod +x "$DIST_APP/Contents/MacOS/BBDown GUI"
        
        # æ¸…ç†æ‰©å±•å±æ€§
        xattr -cr "$DIST_APP"
        
        echo "âœ… åº”ç”¨ç¨‹åºåŒ…è‡ªå®šä¹‰å®Œæˆ"
        
    - name: Create distribution package
      run: |
        APP_NAME="BBDown GUI.app"
        DIST_APP="dist/$APP_NAME"
        
        echo "ğŸ“¦ åˆ›å»ºåˆ†å‘åŒ…..."
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p artifact
        
        # ä½¿ç”¨ ditto åˆ›å»ºå‹ç¼©åŒ…ï¼Œä¿æŒ macOS å…ƒæ•°æ®
        ditto -c -k --keepParent "$DIST_APP" "artifact/BBDown_GUI_Mac.zip"
        
        # æ˜¾ç¤ºåŒ…ä¿¡æ¯
        echo "ğŸ“Š åº”ç”¨ç¨‹åºåŒ…ä¿¡æ¯ï¼š"
        ls -la "$DIST_APP"
        echo "ğŸ“Š å‹ç¼©åŒ…å¤§å°ï¼š"
        ls -lh artifact/BBDown_GUI_Mac.zip
        
        echo "âœ… åˆ†å‘åŒ…åˆ›å»ºå®Œæˆ"
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: BBDown_GUI_Mac_${{ github.run_number }}
        path: artifact/BBDown_GUI_Mac.zip
        retention-days: 30
        
    - name: Build summary
      run: |
        echo "ğŸ‰ macOS æ„å»ºå®Œæˆï¼"
        echo "ğŸ“± åº”ç”¨ç¨‹åºåç§°: BBDown GUI"
        echo "ğŸ—ï¸ æ„å»ºç¼–å·: ${{ github.run_number }}"
        echo "ğŸ“¦ è¾“å‡ºæ–‡ä»¶: BBDown_GUI_Mac.zip"
        echo "ğŸ’¾ æ–‡ä»¶å¤§å°: $(ls -lh artifact/BBDown_GUI_Mac.zip | awk '{print $5}')"
        echo "ğŸ”— ä¸‹è½½é“¾æ¥å°†åœ¨ Actions é¡µé¢çš„ Artifacts éƒ¨åˆ†æä¾›"
